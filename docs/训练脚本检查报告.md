# è®­ç»ƒè„šæœ¬æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¥æœŸ**: 2026-01-15
**è„šæœ¬**: train.py
**çŠ¶æ€**: âœ… å¯ä»¥è¿è¡Œï¼ˆéœ€è¦å°è°ƒæ•´ï¼‰

---

## âœ… é€šè¿‡çš„æ£€æŸ¥é¡¹

### 1. æ¨¡å—å¯¼å…¥ âœ…
- `data.AECSDataLoader` - æ­£å¸¸
- `data.BernoulliCorruptor` - æ­£å¸¸
- `models.ae_cs.AECS` - æ­£å¸¸
- `models.losses.total_loss` - æ­£å¸¸

### 2. æ•°æ®åŠ è½½ âœ…
- æ•°æ®æ–‡ä»¶å­˜åœ¨: `hangmei_90_æ‹¼æ¥å¥½çš„.csv` (1.19 MB)
- æ•°æ®åŠ è½½æ­£å¸¸: è®­ç»ƒé›†1908æ ·æœ¬, éªŒè¯é›†372æ ·æœ¬, æµ‹è¯•é›†372æ ·æœ¬
- æ•°æ®é¢„å¤„ç†æ­£ç¡®: æ ‡å‡†åŒ–æ— æ•°æ®æ³„éœ²

### 3. æ¨¡å‹åˆå§‹åŒ– âœ…
- AECSæ¨¡å‹åˆå§‹åŒ–æˆåŠŸ
- ä¸“åˆ©ç®—æ³•ä¿®å¤ç”Ÿæ•ˆ:
  - éƒ¨åˆ†è·ç¦»ç­–ç•¥ (é—®é¢˜2ä¿®å¤)
  - å˜é‡çº§â†’æ—¶é—´çº§æ˜ å°„ (é—®é¢˜3ä¿®å¤)

### 4. å‰å‘ä¼ æ’­ âœ…
- æ­£å¸¸æ¨¡å¼: è¾“å‡ºå½¢çŠ¶æ­£ç¡® `(batch, time, features)`
- return_allæ¨¡å¼: è¿”å›æ‰€æœ‰ä¸­é—´ç»“æœæ­£å¸¸

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### é—®é¢˜1: GPUå†…å­˜é…ç½® âš ï¸

**ç°è±¡**:
```
CUDA_ERROR_OUT_OF_MEMORY: out of memory
```

**åŸå› **:
- TensorFlowé»˜è®¤å ç”¨æ‰€æœ‰GPUå†…å­˜
- RTX 4060 Laptop GPUåªæœ‰8GBæ˜¾å­˜

**è§£å†³æ–¹æ¡ˆ**:
åœ¨train.pyçš„å¼€å¤´æ·»åŠ GPUå†…å­˜å¢é•¿é…ç½®:

```python
# åœ¨å¯¼å…¥æ¨¡å—ä¹‹åï¼Œåˆå§‹åŒ–è®­ç»ƒå™¨ä¹‹å‰æ·»åŠ 
import tensorflow as tf

# é…ç½®GPUå†…å­˜å¢é•¿
gpus = tf.config.list_physical_devices('GPU')
if gpus:
    try:
        for gpu in gpus:
            tf.config.experimental.set_memory_growth(gpu, True)
        print(f"[OK] GPU memory growth enabled for {len(gpus)} GPU(s)")
    except RuntimeError as e:
        print(f"[WARNING] GPU config failed: {e}")
```

**å»ºè®®æ·»åŠ ä½ç½®**: train.py ç¬¬23è¡Œï¼ˆåœ¨å¯¼å…¥è‡ªå®šä¹‰æ¨¡å—ä¹‹å‰ï¼‰

---

### é—®é¢˜2: use_faisså‚æ•°æœªä½¿ç”¨ â„¹ï¸

**ç°è±¡**:
- train.pyå®šä¹‰äº†`use_faiss`å‚æ•°
- ä½†ä»æœªä¼ é€’ç»™æ¨¡å‹

**è¯´æ˜**:
- FAISSåŠ é€Ÿå‡½æ•°å·²åºŸå¼ƒï¼ˆä¸ç¬¦åˆä¸“åˆ©è¦æ±‚ï¼‰
- å½“å‰ä½¿ç”¨éƒ¨åˆ†è·ç¦»ç­–ç•¥å’Œå˜é‡çº§æ˜ å°„ï¼Œä¸éœ€è¦FAISS
- è¿™ä¸ªå‚æ•°å¯ä»¥åˆ é™¤æˆ–ä¿ç•™ï¼ˆä¸å½±å“è¿è¡Œï¼‰

**å»ºè®®**:
ä¿ç•™å‚æ•°ä½†æ·»åŠ æ³¨é‡Šè¯´æ˜:
```python
# æ³¨æ„: use_faisså‚æ•°å·²åºŸå¼ƒï¼Œå½“å‰ä½¿ç”¨ä¸“åˆ©è¦æ±‚çš„éƒ¨åˆ†è·ç¦»ç­–ç•¥
parser.add_argument('--use_faiss', action='store_true', default=False,
                    help='[å·²åºŸå¼ƒ] æ˜¯å¦ä½¿ç”¨FAISSåŠ é€Ÿ')
```

---

### é—®é¢˜3: å¯¼å…¥äº†æœªä½¿ç”¨çš„æ¨¡å— â„¹ï¸

**ç°è±¡**:
```python
from data import AECSDataLoader, CoherentDenoisingGenerator  # CoherentDenoisingGeneratoræœªä½¿ç”¨
from models.losses import total_loss, bernoulli_corruption    # bernoulli_corruptionæœªä½¿ç”¨
```

**å½±å“**: æ— ï¼Œä»…ä»£ç æ•´æ´é—®é¢˜

**å»ºè®®ä¿®å¤**:
```python
from data import AECSDataLoader
from models.losses import total_loss
```

---

## ğŸ¯ æ¨èçš„è®­ç»ƒå‚æ•°

åŸºäºç¡¬ä»¶é…ç½®ï¼ˆRTX 4060 8GBï¼‰ï¼Œæ¨èä»¥ä¸‹å‚æ•°:

```bash
python train.py \
    --data_path "hangmei_90_æ‹¼æ¥å¥½çš„.csv" \
    --epochs 100 \
    --early_stopping_patience 15 \
    --batch_size 8 \
    --latent_dim 32 \
    --hidden_units 128 \
    --learning_rate 0.001 \
    --use_lr_scheduler \
    --lr_patience 5 \
    --lr_factor 0.5 \
    --min_lr 0.000001 \
    --dropout_rate 0.1 \
    --l2_reg 0.0005 \
    --lambda1 1.0 \
    --lambda2 0.1 \
    --lambda3 0.1 \
    --missing_rate 0.2 \
    --checkpoint_dir "./checkpoints/my_model" \
    --seed 42
```

**å‚æ•°è¯´æ˜**:
- `batch_size=8`: å¯¹8GBæ˜¾å­˜å®‰å…¨
- `latent_dim=32`: å¹³è¡¡æ€§èƒ½å’Œå†…å­˜
- `learning_rate=0.001`: Adamé»˜è®¤å­¦ä¹ ç‡
- `use_lr_scheduler`: å¯ç”¨å­¦ä¹ ç‡è¡°å‡

---

## ğŸ“‹ ä¿®å¤æ¸…å•

### å¿…é¡»ä¿®å¤ (Critical)
- [x] **æ·»åŠ GPUå†…å­˜å¢é•¿é…ç½®** (å¦åˆ™ä¼šOOM)

### å»ºè®®ä¿®å¤ (Optional)
- [ ] åˆ é™¤æœªä½¿ç”¨çš„å¯¼å…¥
- [ ] æ›´æ–°use_faisså‚æ•°æ³¨é‡Š

---

## ğŸš€ å¿«é€Ÿä¿®å¤è„šæœ¬

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°train.pyç¬¬23è¡Œ:

```python
# ===== GPUå†…å­˜é…ç½® (Critical Fix) =====
import tensorflow as tf

gpus = tf.config.list_physical_devices('GPU')
if gpus:
    try:
        for gpu in gpus:
            tf.config.experimental.set_memory_growth(gpu, True)
        print(f"[OK] GPU memory growth enabled for {len(gpus)} GPU(s)")
    except RuntimeError as e:
        print(f"[WARNING] GPU configuration failed: {e}")
else:
    print("[INFO] No GPU detected, using CPU")
# ======================================
```

---

## âœ… æœ€ç»ˆç»“è®º

**è®­ç»ƒè„šæœ¬çŠ¶æ€**: å¯ä»¥è¿è¡Œ âœ…

**å…³é”®ä¿®å¤**:
1. å¿…é¡»æ·»åŠ GPUå†…å­˜å¢é•¿é…ç½®

**é¢„æœŸæ€§èƒ½**:
- è®­ç»ƒæ—¶é—´: çº¦3-5åˆ†é’Ÿ/epoch (GPU) æˆ– 30-60åˆ†é’Ÿ/epoch (CPU)
- å†…å­˜å ç”¨: ~4-6GB GPUå†…å­˜ (batch_size=8)
- æœ€ä¼˜æ€§èƒ½: RÂ²â‰ˆ0.73, MAEâ‰ˆ0.42 (æ ¹æ®å†å²ç»“æœ)

**å»ºè®®**:
1. å…ˆç”¨å°æ‰¹æ¬¡(batch_size=4)æµ‹è¯•1ä¸ªepoch
2. ç¡®è®¤æ— é”™è¯¯åå†ç”¨å®Œæ•´å‚æ•°è®­ç»ƒ
3. ç›‘æ§GPUå†…å­˜ä½¿ç”¨: `nvidia-smi -l 1`

---

**ç”Ÿæˆæ—¶é—´**: 2026-01-15 18:10
**æ£€æŸ¥å·¥å…·**: Claude Code
